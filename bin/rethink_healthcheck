#!/usr/bin/env python3

# Copyright 2019 Contributors to Hyperledger Sawtooth
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ------------------------------------------------------------------------------
"""Healthcheck script that queries rethinkDB for the number of ready tables. 
Sets the container state to healthy only if the expected number of tables are
initialized.
"""


import sys
import os
import rethinkdb as r

from rethinkdb.errors import ReqlRuntimeError


TOP_DIR = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))
sys.path.insert(0, TOP_DIR)

LOGGER = logging.getLogger(__name__)

DB_HOST = os.getenv('DB_HOST', 'rethink')
DB_PORT = os.getenv('DB_PORT', '28015')
DB_NAME = os.getenv('DB_NAME', 'rbac')

get_ready_table_count(host, port, name):
    """Queries RethinkDB and returns the number of ready tables
    
    Returns:
        ready_table_count:
            int: The number of ready tables in RethinkDB.
    """
    with r.connect(host=host, port=port) as conn:
        response = r.db("rbac").wait().coerce_to("object").run(conn)
        ready_table_count = response["ready"]
        return ready_table_count


if __name__ == '__main__':
    ready_table_count = get_ready_table_count(DB_HOST, DB_PORT, DB_NAME)
    exit_code = 1
    if ready_table_count == 25:
        exit_code = 0 
    exit(exit_code)
